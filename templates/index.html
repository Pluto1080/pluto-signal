<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TERMINAL: PLUTO</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            background: radial-gradient(circle at center, #1a0033 0%, #000000 100%);
            color: #00ff41; font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 0; overflow: hidden;
            height: 100vh; width: 100vw;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
            transition: opacity 0.5s ease-in-out;
            opacity: 0; pointer-events: none; z-index: 0;
        }
        .screen.active {
            opacity: 1; pointer-events: auto; z-index: 10;
        }

        /* 광택이 흐르는 제목 효과 */
        h1.shiny-title { 
            font-size: 1.8rem; letter-spacing: 5px; text-align: center; margin-bottom: 30px; 
            background: linear-gradient(90deg, #00ff41, #ffffff, #00ff41);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shine 3s linear infinite;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        @keyframes shine {
            to { background-position: 200% center; }
        }

        button.cyber-btn {
            background: #00ff41; color: #000; border: none; padding: 15px; width: 100%;
            font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 0 15px #00ff41; margin-top: 20px;
        }
        button.cyber-btn:hover { background: #ff00ff; box-shadow: 0 0 20px #ff00ff; color: #fff; }

        #screen-input .container {
            width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            border: 1px solid #00ff41; padding: 25px;
            background: rgba(20, 0, 40, 0.8);
            box-shadow: inset 0 0 20px rgba(128, 0, 255, 0.2);
        }
        .input-group { margin-bottom: 15px; width: 100%; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #ff00ff; font-size: 0.9rem; }
        input, select {
            background: transparent; border: 1px solid #00ff41; color: #00ff41; padding: 10px; width: 100%;
            font-size: 1rem; outline: none; -webkit-appearance: none;
        }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1) sepia(1) saturate(5) hue-rotate(80deg);
        }

        #map { height: 200px; width: 100%; border: 1px solid #00ff41; filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(80%); }

        #screen-loading { background: #000; overflow: hidden; }
        
        /* 신비로운 로딩 텍스트 스타일 */
        #loading-text { 
            font-size: 1.5rem; color: #FFD700; text-shadow: 0 0 10px #FFD700, 0 0 20px #ff8800; 
            z-index: 20; text-align: center; letter-spacing: 2px;
            animation: pulse 1.5s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 0.7; filter: drop-shadow(0 0 5px #FFD700); }
            to { opacity: 1; filter: drop-shadow(0 0 15px #FFD700); }
        }

        /* 사선으로 떨어지는 별똥별 효과 */
        .star { 
            position: absolute; 
            background: linear-gradient(to bottom, rgba(255, 235, 59, 1) 0%, transparent 100%); 
            border-radius: 50%;
            filter: drop-shadow(0 0 8px #FFD700); 
            animation: shooting-star linear infinite; 
            opacity: 0;
            transform-origin: top; 
        }
        @keyframes shooting-star { 
            0% { transform: translate(0, 0) rotate(45deg); opacity: 1; } 
            100% { transform: translate(-60vw, 100vh) rotate(45deg); opacity: 0; } 
        }

        #screen-result { padding: 20px 10px; overflow-y: auto; display: block; }
        #screen-result .container { width: 100%; max-width: 700px; margin: 0 auto; }
        .result-box { margin-bottom: 25px; border: 1px solid #00ff41; padding: 20px; background: rgba(20, 0, 40, 0.6); position: relative; }
        .result-box h2 { margin-top: 0; color: #ff00ff; font-size: 1.3rem; border-bottom: 1px dashed #00ff41; padding-bottom: 10px; letter-spacing: 2px; }
        .result-content { white-space: pre-wrap; line-height: 1.6; font-size: 1.05rem; word-break: keep-all; }
        .pros-box { border-color: #00ffff; box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); }
        .cons-box { border-color: #ff0055; box-shadow: 0 0 15px rgba(255, 0, 85, 0.3); }
        .pros-box h2 { color: #00ffff; }
        .cons-box h2 { color: #ff0055; }
    </style>
</head>
<body>
    <section id="screen-input" class="screen active">
        <div class="container">
            <h1 class="shiny-title">ACCESS: PLUTO</h1>
            <p style="text-align: center; color: #8844ff; font-size: 0.8rem; margin-top:-15px;">>> ASTRO_DATA_REQUIRED...</p>
            
            <div class="input-group">
                <label>NAME</label>
                <input type="text" id="userName" placeholder="이름 입력">
            </div>
            <div class="input-group" style="display: flex; gap: 10px;">
                <div style="flex: 2;">
                    <label>BIRTH_DATE</label>
                    <input type="date" id="birthDate" max="9999-12-31">
                </div>
                <div style="flex: 1.5;">
                    <label>BIRTH_TIME (24H)</label>
                    <input type="time" id="birthTime" lang="en-GB">
                </div>
            </div>
            <div style="margin-bottom: 15px; display: flex; align-items: center;">
                <input type="checkbox" id="timeUnknown" onchange="toggleTimeInput()" style="width: auto; margin-right: 8px;">
                <label for="timeUnknown" style="display: inline; color: #00ff41; margin:0; font-size:0.9rem;">시간 모름 (정확도 ↓)</label>
            </div>
            <div class="input-group">
                <label>LOCATION (터치하여 핀 고정)</label>
                <div id="map"></div>
                <span id="coordsDisplay" style="font-size: 0.7rem; color: #8844ff;">위도: 37.5665 / 경도: 126.9780 (서울)</span>
            </div>
            <button class="cyber-btn" onclick="startAnalysis()">INITIATE_SEQUENCE</button>
        </div>
    </section>

    <section id="screen-loading" class="screen">
        <div id="loading-text">별의 소리를 관측하는 중</div>
    </section>

    <section id="screen-result" class="screen">
        <div class="container" style="padding-top: 30px;">
             <h1 class="shiny-title" style="font-size: 1.5rem;">ANALYSIS_COMPLETE</h1>
             <div class="result-box personality-box">
                 <h2>>> CORE_PERSONALITY (성격)</h2>
                 <div id="res-personality" class="result-content">데이터 로딩 중...</div>
             </div>
             <div class="result-box pros-box">
                 <h2>[+] STRENGTHS (장점)</h2>
                 <div id="res-pros" class="result-content">데이터 로딩 중...</div>
             </div>
             <div class="result-box cons-box">
                 <h2>[-] WEAKNESSES (단점)</h2>
                 <div id="res-cons" class="result-content">데이터 로딩 중...</div>
             </div>
             <button class="cyber-btn" onclick="location.reload()" style="margin-bottom: 30px;">RESTART_SESSION</button>
        </div>
    </section>

    <script>
        let selectedLat = 37.5665; let selectedLon = 126.9780;
        const map = L.map('map', { zoomControl: false }).setView([selectedLat, selectedLon], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
        let marker = L.marker([selectedLat, selectedLon]).addTo(map);
        map.on('click', function(e) {
            selectedLat = e.latlng.lat; selectedLon = e.latlng.lng;
            marker.setLatLng(e.latlng);
            document.getElementById('coordsDisplay').innerText = `위도: ${selectedLat.toFixed(4)} / 경도: ${selectedLon.toFixed(4)}`;
        });

        function toggleTimeInput() {
            const timeInput = document.getElementById('birthTime');
            const isUnknown = document.getElementById('timeUnknown').checked;
            timeInput.disabled = isUnknown;
            timeInput.style.opacity = isUnknown ? "0.5" : "1";
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        let loadingInterval;
        function startLoadingAnimation() {
            switchScreen('screen-loading');
            const loadingScreen = document.getElementById('screen-loading');
            
            // 별똥별 애니메이션 생성 (사선으로 떨어지도록 좌표 범위 확장)
            for(let i=0; i<40; i++) {
                let star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 150}vw`; 
                star.style.top = `-${Math.random() * 30}vh`;
                
                const scale = Math.random() * 2 + 0.5;
                star.style.width = `${2 * scale}px`;
                star.style.height = `${30 * scale}px`;
                
                star.style.animationDuration = `${Math.random() * 1 + 0.5}s`;
                star.style.animationDelay = `${Math.random() * 2}s`;
                
                loadingScreen.appendChild(star);
            }
            
            const textElement = document.getElementById('loading-text');
            let dots = 0;
            loadingInterval = setInterval(() => {
                dots = (dots + 1) % 4;
                textElement.innerText = "별의 소리를 관측하는 중" + ".".repeat(dots);
            }, 500);
        }

        function stopLoadingAnimation() {
            clearInterval(loadingInterval);
            document.querySelectorAll('.star').forEach(e => e.remove());
        }

        function startAnalysis() {
            const name = document.getElementById('userName').value;
            const date = document.getElementById('birthDate').value;
            const isUnknown = document.getElementById('timeUnknown').checked;
            let time = document.getElementById('birthTime').value;

            const userLang = navigator.language || 'ko-KR';

            if(!name || !date || (!isUnknown && !time)) { alert("필수 데이터를 모두 입력하라."); return; }
            if(isUnknown) time = "12:00";

            startLoadingAnimation();

            fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name, date, time, 
                    time_unknown: isUnknown, 
                    lat: selectedLat, 
                    lon: selectedLon,
                    language: userLang
                })
            })
            .then(response => response.json())
            .then(data => {
                stopLoadingAnimation();
                if (data.error) {
                    alert("오류 발생: " + data.error);
                    switchScreen('screen-input');
                    return;
                }
                document.getElementById('res-personality').innerText = data.personality || "분석 실패";
                document.getElementById('res-pros').innerText = data.pros || "데이터 없음";
                document.getElementById('res-cons').innerText = data.cons || "데이터 없음";
                switchScreen('screen-result');
            })
            .catch(err => {
                stopLoadingAnimation();
                alert("치명적 통신 오류: " + err);
                switchScreen('screen-input');
            });
        }
    </script>
</body>
</html>
